@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script type='text/javascript'>
    var gcm = window.GuestCheckinManager;

    function OnUnitChange(ddlUnit, ddlHour) {
        if (ddlUnit && ddlUnit.value === 'Daily'){
            if (ddlHour && ddlHour[0] && ddlHour[0].style.cssText === "display: block;") {
                ddlHour.attr("disabled", "disabled");
            }else{
                $('#ddlHourClone').attr("disabled", "disabled");
            } 
        } else {
            ddlHour.removeAttr("disabled");
        }
    }

    function makeFieldsReadonly(rowObject) {
        rowObject.attr('contenteditable', 'false');
        rowObject.css('background-color', 'transparent');
    }

    function OnPropertyChange() {
        if ($('#ddlProperty').val() <= 0) {
            alert('Select valid property');
            return;
        }
        gcm.GetRoomRateType($('#ddlProperty').val());
    }

    $(document).ready(function () {

        gcm.GetAllProperty();

        $("#divRateType").on("click", ".fa-plus-circle", function () {
            $(this).closest('tr').after('<tr><td class="idRow" contenteditable="false"></td><td contenteditable="true" style="background-color: #ffc9c9;"></td><td contenteditable="true" style="background-color: #ffc9c9;"><select style="display:block" id="ddlUnitClone" class="form-control"><option value="Hourly">Hourly</option><option value="Daily">Daily</option></select></td><td contenteditable="true" style="background-color: #ffc9c9;"><select style="display:block" id="ddlHourClone" onchange="OnUnitChange(this);" class="form-control"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></td><td class="finalActionsCol"><i class="fa  fa-plus-circle" aria-hidden="true"></i><i class="fa fa-minus-circle" aria-hidden="true"></i><i class="fa fa-floppy-o editMode" aria-hidden="true"></i></td></tr>');
        });

        $("#divRateType").on("click", ".fa-minus-circle", function () {
            if (confirm("Are you sure you want to delete ?")) {
                var rateTypeId = $(this).closest('tr')[0].id;
                $(this).closest('tr').remove();
                if (rateTypeId <= 0) return;
                gcm.DeleteRateType(rateTypeId);
                if ($('#divRateType tbody tr').length <= 0) {
                    $('#ddlProperty').val('-1');
                }
            }
        });

        $("#divRateType").on("click", ".fa-pencil-square-o, .fa-floppy-o", function () {
            var thisRow = $(this).parent().siblings();
            var editOn = $(this).hasClass("editMode");
            var rateTypeId = $(thisRow)[0].innerText;
            var propertyId = $('#ddlProperty').val();
            var rateTypeName = $(thisRow)[1].innerText;
            if (editOn == false) {
                gcm.OnGridEdit(editOn, $(thisRow), $(this));

                var cloneUnit = $('#ddlUnitClone').clone(true);
                cloneUnit[0].style = 'display:block';
                cloneUnit[0].id = 'ddlUnitClone' + rateTypeId;
                var unitSelector = '#' + cloneUnit[0].id;
                $(thisRow)[2].innerText = "";
                $(thisRow[2]).append(cloneUnit);

                var cloneHour = $('#ddlHourClone').clone(true);
                cloneHour[0].style = 'display:block';
                cloneHour[0].id = 'ddlHourClone' + rateTypeId;
                cloneHour.removeAttr("disabled");
                var hourSelector = '#' + cloneHour[0].id;
                $(thisRow)[3].innerText = "";
                $(thisRow[3]).append(cloneHour);

                $(document).on('change', unitSelector, function () {
                    OnUnitChange($(cloneUnit)[0], $(cloneHour));
                });

                makeFieldsReadonly($(thisRow[0]));
            } else if (editOn == true) {
                var units = $(thisRow)[2].children[0].value;
                var hours = $(thisRow)[3].children[0].value;
                if (units === 'Daily') {
                    hours = null;
                }

                if (!rateTypeName || rateTypeName.length <= 0) {
                    alert("Rate type name is required");
                    return;
                }
                if (rateTypeId > 0) {
                    var existingRateType = gcm.FindPropertySetting(rateTypeId);
                    if (!existingRateType) return;
                    existingRateType.Name = rateTypeName;
                    existingRateType.Units = units;
                    existingRateType.Hours = hours;
                    //call UpdateRateType api
                    gcm.UpdateRateType(existingRateType);
                } else {
                    if (propertyId <= 0) {
                        alert("Select valid property");
                        return;
                    }
                    var rateType = {};
                    rateType.Name = rateTypeName;
                    rateType.Units = units;
                    rateType.PropertyId = propertyId;
                    rateType.Hours = hours;
                    //call AddRateType api
                    gcm.AddRateType(rateType);
                }
                gcm.OnGridEdit(editOn, $(thisRow), $(this));
            }
        });

    });
</script>
<div class="content-wrap">
    <div class="main controls">
        <div class="container-fluid">
            <div class="col-lg-12 p-r-0 p-l-0">
                <div class="card alert">
                    <div class="card-header">
                        <h4>Create Rate type</h4>
                    </div>
                    <div class="card-body room-details">
                        <div class="row" style="">
                            <div class="form-group col-lg-8 m-t-10">
                                <label>Search</label>
                                <input type="text" class="search form-control" placeholder="Search by Rate type name, Units...">
                            </div>

                            <div class="col-lg-2 p-l-0 p-r-0 m-t-10">
                                <div class="form-group">
                                    <label>Select Property</label>
                                    <select id="ddlProperty" onchange="OnPropertyChange();">
                                        <option value="-1">Select Property</option>
                                    </select>
                                </div>
                            </div>
                            <span class="counter"></span>
                            <div id="divRateType" class="table-data">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="divLoader">
    <div class="loader" style="display:none;">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>
</div>
<select style="display:none" id="ddlUnitClone" onchange="OnUnitChange(this, $('#ddlHourClone'));" class="form-control">
    <option value="Hourly">Hourly</option>
    <option value="Daily">Daily</option>
</select>

<select style="display:none" id="ddlHourClone" class="form-control">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
</select>

<script type="text/html" id="rateTemplate">
    <table class="table table-hover table-bordered results tableContents">
        <thead>
            <tr>
                <th id="IDCol">ID #</th>
                <th id="rateTypeCol" contenteditable="false">Rate Type</th>
                <th id="unitsCol" contenteditable="false">Units</th>
                <th id="hoursCol" contenteditable="false">Hours</th>
            </tr>
        </thead>
        <tbody>
            {{if typeof RateTypes != "undefined" && RateTypes != "null" && RateTypes.length > 0 }}
            {{each RateTypes}}
            <tr id="${$value.Id}">
                <td class="idRow" contenteditable="false">${$value.Id}</td>
                <td contenteditable="false">${$value.Name}</td>
                <td contenteditable="false">${$value.Units}</td>
                <td contenteditable="false">${$value.Hours}</td>
            </tr>
            {{/each}}
            {{else}}
            <tr>
                <td class="idRow" contenteditable="false"></td>
                <td contenteditable="true" style="background-color: #ffc9c9;"></td>
                <td contenteditable="true" style="background-color: #ffc9c9;"></td>
                <td contenteditable="true" style="background-color: #ffc9c9;"></td>
            </tr>
            {{/if}}
        </tbody>
    </table>
</script>

